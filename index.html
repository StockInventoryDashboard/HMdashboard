<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Manager - Dashboard</title>
    <style>
        /* CSS - STYLING THE DASHBOARD */
        :root {
            --primary-color: #0a2351;
            --secondary-color: #f8f9fa;
            --accent-color: #c5a47e; /* Softer gold/bronze */
            --text-color: #343a40;
            --light-text-color: #fff;
            --green: #28a745;
            --red: #dc3545;
            --blue: #007bff;
            --orange: #fd7e14;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@300;400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            font-family: 'Lato', sans-serif;
        }
        
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Playfair Display', serif;
            color: var(--primary-color);
        }

        .hidden { display: none !important; }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: var(--primary-color);
            background-image: linear-gradient(135deg, var(--primary-color) 0%, #1e3a8a 100%);
        }

        .login-container {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            text-align: center;
            width: 100%;
            max-width: 400px;
        }
        
        .login-container h1 { margin-bottom: 10px; }
        .login-container p { margin-bottom: 25px; color: var(--gray); }
        .login-form input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; font-family: 'Lato', sans-serif;}
        .login-form button { width: 100%; padding: 12px; background-color: var(--primary-color); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: 600; transition: background-color 0.3s; }
        .login-form button:hover { background-color: #1e3a8a; }
        #login-error { color: var(--red); margin-top: 10px; font-size: 14px; }

        /* --- MAIN APP LAYOUT --- */
        .app-container { display: flex; }
        .sidebar { width: 260px; background: var(--primary-color); color: var(--light-text-color); min-height: 100vh; padding: 20px 0; position: fixed; top: 0; left: 0; display: flex; flex-direction: column; }
        .sidebar-header { text-align: center; padding: 0 20px 20px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-header h2 { font-size: 28px; color: var(--accent-color); }
        .sidebar-nav { list-style: none; flex-grow: 1; }
        .sidebar-nav ul li a { display: block; padding: 15px 30px; color: var(--light-text-color); text-decoration: none; transition: background 0.3s, color 0.3s; font-weight: 400; border-left: 4px solid transparent; }
        .sidebar-nav ul li a:hover, .sidebar-nav ul li a.active { background: rgba(255, 255, 255, 0.05); color: var(--accent-color); border-left-color: var(--accent-color); }
        .sidebar-footer { padding: 20px; text-align: center; font-size: 12px; color: rgba(255,255,255,0.4); }
        .main-content { margin-left: 260px; width: calc(100% - 260px); padding: 0; }
        .main-header { background: #fff; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .user-info { font-weight: 700; font-size: 16px; }
        .user-info span { font-weight: 400; color: var(--gray); }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        #backup-status { font-size: 12px; color: var(--gray); font-style: italic; }
        #logout-btn, #change-password-btn { border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 500; }
        #logout-btn { background: var(--red); color: white; }
        #change-password-btn { background: var(--gray); color: white;}
        .content-view { padding: 30px; }
        .view-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid var(--light-gray); flex-wrap: wrap; gap: 15px;}
        .view-header h1 { font-size: 36px; margin: 0; }
        
        /* --- WIDGETS --- */
        .widget-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .widget { background: #fff; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); transition: transform 0.2s; }
        .widget:hover { transform: translateY(-5px); }
        .widget h3 { margin-bottom: 15px; font-size: 20px; color: var(--gray); font-weight: 700; font-family: 'Lato';}
        .widget .value { font-size: 42px; font-weight: 700; color: var(--primary-color); font-family: 'Lato';}
        .widget .value.green { color: var(--green); }
        .widget .value.red { color: var(--red); }
        .widget .value.blue { color: var(--blue); }

        /* --- SYSTEM VIEW --- */
        .system-card { background: #fff; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        .system-card h2 { margin-bottom: 15px; border-bottom: 1px solid var(--light-gray); padding-bottom: 10px; }
        .system-card p { margin-bottom: 20px; color: var(--gray); line-height: 1.5; }
        .system-card .last-backup-info { font-size: 14px; font-style: italic; color: var(--primary-color); }
        .danger-btn { background-color: var(--orange); }
        .danger-btn:hover { background-color: #e06c0d; }

        /* --- P&L VIEW --- */
        #pl-view .widget-grid {
            background: linear-gradient(135deg, #f3f2ff, #e8eaff);
            padding: 25px;
            border-radius: var(--border-radius);
        }

        /* --- ROOMS VIEW --- */
        .room-category { margin-bottom: 40px; }
        .room-category h2 { margin-bottom: 15px; font-size: 24px; padding-bottom: 10px; border-bottom: 2px solid var(--light-gray);}
        .room-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .room-card { border: 1px solid transparent; border-radius: var(--border-radius); padding: 10px; text-align: center; transition: all 0.3s ease; font-weight: 700; background: #fff; box-shadow: var(--box-shadow); display: flex; flex-direction: column; justify-content: space-between; }
        .room-details { cursor: pointer; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; padding: 5px 0; }
        .room-card.available .room-details:hover { transform: scale(1.05); }
        .room-card.available { border-left: 5px solid var(--green); }
        .room-card.booked { border-left: 5px solid var(--red); background-color: #fdf2f2; }
        .room-card.booked .room-name { color: var(--red); }
        .room-card .room-name { font-size: 20px; margin-bottom: 5px; color: var(--green); }
        .room-card .room-price { font-size: 14px; font-weight: 400; color: var(--gray); }
        .room-actions { display: flex; justify-content: space-around; padding-top: 10px; border-top: 1px solid var(--light-gray); margin-top: 10px; }
        .room-actions .action-btn { padding: 4px 8px; font-size: 12px; }
        
        /* --- TABLES & CONTROLS --- */
        .data-table-container { background: #fff; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); overflow-x: auto; margin-bottom: 30px; }
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;}
        .table-controls h2 { margin: 0; font-size: 24px; }
        .primary-btn { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 15px; font-weight: 500; transition: background-color 0.3s; }
        .primary-btn:hover { background-color: #1e3a8a; }
        .secondary-btn { background: var(--green); }
        .secondary-btn:hover { background: #23923d; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--light-gray); }
        .data-table th { background-color: var(--secondary-color); font-weight: 700; color: var(--primary-color); font-family: 'Lato';}
        .data-table tbody tr:hover { background-color: #f1f3f5; }
        .low-stock { color: var(--red); font-weight: bold; }
        .action-btn-group { display: flex; gap: 8px; }
        .action-btn { color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .print-btn { background-color: var(--gray); }
        .edit-btn { background-color: var(--blue); }
        .delete-btn { background-color: var(--red); }
        .filter-controls { display: flex; align-items: center; gap: 10px; }
        .filter-controls label { font-weight: 700; }

        /* --- MODAL STYLES --- */
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 650px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-gray); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-header h2 { font-size: 28px; }
        .close-btn { color: #aaa; font-size: 32px; font-weight: bold; cursor: pointer; }
        .close-btn:hover { color: #000; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 700; font-family: 'Lato';}
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; font-family: 'Lato';}
        .modal-footer { margin-top: 25px; text-align: right; }
        .sale-item-adder { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; align-items: center; border-bottom: 1px solid #ccc; padding-bottom: 15px; margin-bottom: 15px;}
        #sale-items-list-container { max-height: 200px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 5px; }
        
        /* --- RECEIPT STYLES --- */
        #receipt-content { font-family: 'Courier New', Courier, monospace; padding: 20px; border: 1px dashed #333; max-width: 400px; margin: 0 auto; }
        #receipt-header h3 { font-family: 'Courier New', Courier, monospace; color: #000; }
        @media print { body * { visibility: hidden; } #receipt-modal, #receipt-modal * { visibility: visible; } #receipt-modal { position: absolute; left: 0; top: 0; width: 100%; height: 100%; padding: 0; margin: 0; border: none; box-shadow: none; } .modal-content, .modal-header, .modal-footer { visibility: hidden !important; } #receipt-content { visibility: visible !important; border: none; max-width: 100%; } }
    </style>
</head>
<body>

    <!-- ======== LOGIN SCREEN ======== -->
    <div id="login-screen">
        <div class="login-container">
            <h1>Hotel Manager Dashboard</h1>
            <p>Welcome! Please sign in.</p>
            <form id="login-form" class="login-form">
                <input type="text" id="username" placeholder="Username" required>
                <input type="password" id="password" placeholder="Password" required>
                <button type="submit">Login</button>
                <p id="login-error" class="hidden">Invalid credentials.</p>
            </form>
        </div>
    </div>

    <!-- ======== MAIN APPLICATION ======== -->
    <div id="main-app" class="hidden">
        <div class="app-container">
            <!-- SIDEBAR -->
            <nav class="sidebar">
                <div class="sidebar-header">
                    <h2>Hotel Manager</h2>
                </div>
                <div class="sidebar-nav">
                    <ul id="sidebar-nav"></ul>
                </div>
                <div class="sidebar-footer">
                    &copy; 2025 Hotel Manager. All Rights Reserved.
                </div>
            </nav>

            <!-- MAIN CONTENT -->
            <div class="main-content">
                <header class="main-header">
                    <div class="user-info">
                        Logged in as: <strong id="user-name-display"></strong> <span>(<span id="user-role-display"></span>)</span>
                    </div>
                    <div class="header-actions">
                        <span id="backup-status">All changes saved</span>
                        <button id="change-password-btn">Change Password</button>
                        <button id="logout-btn">Logout</button>
                    </div>
                </header>

                <main class="content-container">
                    <!-- VIEWS WILL BE INSERTED HERE -->
                    <div id="admin-dashboard-view" class="content-view hidden"></div>
                    <div id="front-desk-dashboard-view" class="content-view hidden"></div>
                    <div id="rooms-view" class="content-view hidden"></div>
                    <div id="sales-view" class="content-view hidden"></div>
                    <div id="inventory-view" class="content-view hidden"></div>
                    <div id="staff-view" class="content-view hidden"></div>
                    <div id="assets-view" class="content-view hidden"></div>
                    <div id="reports-view" class="content-view hidden"></div>
                    <div id="pl-view" class="content-view hidden"></div>
                    <div id="system-view" class="content-view hidden"></div>
                </main>
            </div>
        </div>
    </div>
    
    <!-- ======== MODALS ======== -->
    <div id="booking-modal" class="modal hidden"></div>
    <div id="new-sale-modal" class="modal hidden"></div>
    <div id="receipt-modal" class="modal hidden"></div>
    <div id="inventory-modal" class="modal hidden"></div>
    <div id="staff-modal" class="modal hidden"></div>
    <div id="asset-modal" class="modal hidden"></div>
    <div id="change-password-modal" class="modal hidden"></div>
    <div id="room-modal" class="modal hidden"></div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // =================================================================
            // STATE MANAGEMENT & DATA PERSISTENCE
            // =================================================================
            let state = {};
            // In-memory flags that do not get saved to localStorage
            const transientState = {
                upcomingCheckoutAlertsShown: new Set(),
                expiredBookingAlertsShown: new Set()
            };
            let checkoutAlertInterval = null;

            const getDefaultState = () => ({
                currentUser: null,
                staff: [
                    // Staff with login access
                    { id: 1, username: 'admin', password: 'admin123', name: 'Admin User', role: 'Admin', department: 'Administration', salary: 500000 },
                    { id: 2, username: 'frontdesk', password: 'desk123', name: 'Ada Okoro', role: 'Front Desk', department: 'Front Desk', salary: 80000 },
                    { id: 3, username: 'manager', password: 'manager123', name: 'John Doe', role: 'Manager', department: 'Administration', salary: 250000 },
                    // Staff without login access
                    { id: 4, username: '', password: '', name: 'Bello Musa', role: 'Security', department: 'Security', salary: 45000 },
                    { id: 5, username: '', password: '', name: 'Jane Smith', role: 'Housekeeping', department: 'Housekeeping', salary: 40000 },
                ],
                rooms: [],
                inventory: [
                    { id: 1, name: 'Coca-Cola', department: 'Bar', stock: 80, price: 500, cost: 250, lowStockThreshold: 24 },
                    { id: 2, name: 'Heineken', department: 'Bar', stock: 15, price: 1000, cost: 600, lowStockThreshold: 12 },
                    { id: 3, name: 'Basmati Rice (kg)', department: 'Kitchen', stock: 50, price: 2500, cost: 1800, lowStockThreshold: 10 },
                    { id: 4, name: 'Chicken Breast (kg)', department: 'Kitchen', stock: 8, price: 4000, cost: 3000, lowStockThreshold: 5 },
                    { id: 5, name: 'Guest Shampoo', department: 'Housekeeping', stock: 200, price: 200, cost: 80, lowStockThreshold: 50 },
                    { id: 6, name: 'Guest Soap', department: 'Housekeeping', stock: 300, price: 150, cost: 50, lowStockThreshold: 50 },
                    { id: 7, name: 'Guest Water Bottle', department: 'Housekeeping', stock: 400, price: 300, cost: 100, lowStockThreshold: 100 },
                ],
                assets: [
                    { id: 1, name: 'Samsung 55" TV', department: 'Rooms', purchaseDate: '2023-01-15', value: 1000 },
                    { id: 2, name: 'Industrial Oven', department: 'Kitchen', purchaseDate: '2022-11-20', value: 1000 },
                    { id: 3, name: 'Reception Desk', department: 'Office', purchaseDate: '2022-10-01', value: 1000 },
                ],
                sales: [],
                lastBackup: null
            });
            
            let currentSaleItems = [];

            function saveStateToLocalStorage() {
                try {
                    const backupStatus = document.getElementById('backup-status');
                    backupStatus.textContent = "Saving...";
                    state.lastBackup = new Date().toISOString();
                    localStorage.setItem('HotelManagerData', JSON.stringify(state));
                    setTimeout(() => { backupStatus.textContent = "All changes saved"; }, 500);
                } catch (error) {
                    console.error("Failed to save state:", error);
                    document.getElementById('backup-status').textContent = "Save failed!";
                }
            }

            function loadStateFromLocalStorage() {
                const savedState = localStorage.getItem('HotelManagerData');
                if (savedState) {
                    state = JSON.parse(savedState);
                } else {
                    state = getDefaultState();
                    generateRooms(); // Only generate rooms if starting fresh
                }
            }
            
            function saveStateAndReRender() {
                saveStateToLocalStorage();
                renderAllViews();
            }

            // =================================================================
            // INITIALIZATION
            // =================================================================
            function init() {
                loadStateFromLocalStorage();
                populateInitialViewHTML();
                setupEventListeners();
            }

            function populateInitialViewHTML() {
                document.getElementById('admin-dashboard-view').innerHTML = `<div class="view-header"><h1>Admin Dashboard</h1></div> <div class="widget-grid"> <div class="widget"><h3>Rooms Available</h3><p class="value green" id="admin-rooms-available"></p></div><div class="widget"><h3>Rooms Booked</h3><p class="value red" id="admin-rooms-booked"></p></div><div class="widget"><h3>Today's Sales (Total)</h3><p class="value" id="admin-today-sales"></p></div><div class="widget"><h3>Low Stock Alerts</h3><p class="value red" id="admin-low-stock-count"></p></div></div>`;
                document.getElementById('front-desk-dashboard-view').innerHTML = `<div class="view-header"><h1>Front Desk Dashboard</h1></div> <div class="widget-grid"> <div class="widget"><h3>Rooms Available</h3><p class="value green" id="fd-rooms-available"></p></div><div class="widget"><h3>Rooms Booked</h3><p class="value red" id="fd-rooms-booked"></p></div><div class="widget"><h3>Check-outs Today</h3><p class="value blue" id="fd-expiring-today"></p></div></div>`;
                document.getElementById('rooms-view').innerHTML = `<div class="view-header"><h1>Room Management</h1><button id="add-room-btn" class="primary-btn hidden">Add New Room</button></div> <div class="room-category"><h2>Standard Rooms</h2><div id="standard-room-grid" class="room-grid"></div></div> <div class="room-category"><h2>Deluxe Rooms</h2><div id="deluxe-room-grid" class="room-grid"></div></div> <div class="room-category"><h2>Suites</h2><div id="suite-room-grid" class="room-grid"></div></div>`;
                document.getElementById('sales-view').innerHTML = `<div class="view-header"><h1>Sales & Receipts</h1></div> <div class="data-table-container"> <div class="table-controls"> <h2>All Transactions</h2> <button id="new-sale-btn" class="primary-btn">Log New Sale</button> </div> <table class="data-table"> <thead><tr><th>ID</th><th>Customer</th><th>Amount (₦)</th><th>Staff</th><th>Date</th><th>Actions</th></tr></thead> <tbody id="sales-table-body"></tbody> </table> </div>`;
                document.getElementById('inventory-view').innerHTML = `<div class="view-header"><h1>Inventory Management</h1></div> <div class="data-table-container"><div class="table-controls"><h2>All Items</h2><button id="add-inventory-btn" class="primary-btn">Add New Item</button></div><table class="data-table"><thead><tr><th>Item</th><th>Department</th><th>Stock</th><th>Cost Price (₦)</th><th>Sell Price (₦)</th><th>Status</th><th>Actions</th></tr></thead><tbody id="inventory-table-body"></tbody></table></div>`;
                document.getElementById('staff-view').innerHTML = `<div class="view-header"><h1>Staff Management</h1></div> <div class="data-table-container"><div class="table-controls"><h2>All Staff</h2><button id="add-staff-btn" class="primary-btn">Add New Staff</button></div><table class="data-table"><thead><tr><th>Name</th><th>Role</th><th>Department</th><th>Salary (₦)</th><th>Actions</th></tr></thead><tbody id="staff-table-body"></tbody></table></div>`;
                document.getElementById('assets-view').innerHTML = `<div class="view-header"><h1>Asset Management</h1></div> <div class="data-table-container"><div class="table-controls"><h2>All Assets</h2><button id="add-asset-btn" class="primary-btn">Add New Asset</button></div><table class="data-table"><thead><tr><th>Asset Name</th><th>Department</th><th>Purchase Date</th><th>Value (₦)</th><th>Actions</th></tr></thead><tbody id="asset-table-body"></tbody></table></div>`;
                document.getElementById('reports-view').innerHTML = `<div class="view-header"><h1>Reporting & Analytics</h1><div class="filter-controls"><label for="report-start-date">From:</label><input type="date" id="report-start-date"><label for="report-end-date">To:</label><input type="date" id="report-end-date"><button id="report-filter-btn" class="primary-btn">Filter</button><button id="export-csv-btn" class="primary-btn secondary-btn">Export as CSV</button></div></div><div id="reports-summary-grid" class="widget-grid"></div><div id="consumption-trends-container" class="data-table-container"><h2>Top Consumed Items</h2><table class="data-table"><thead><tr><th>Item</th><th>Department</th><th>Total Consumed</th></tr></thead><tbody id="consumption-trends-body"></tbody></table></div>`;
                document.getElementById('pl-view').innerHTML = `<div class="view-header"><h1>Profit & Loss Analysis</h1><div class="form-group" style="max-width: 250px;"><label for="pl-period-select">Select Period</label><select id="pl-period-select"><option value="daily">Today</option><option value="monthly" selected>This Month</option><option value="yearly">This Year</option></select></div></div><div class="widget-grid" id="pl-summary-grid"></div>`;
                document.getElementById('system-view').innerHTML = `<div class="view-header"><h1>System Management</h1></div> <div class="widget-grid" style="grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));"> <div class="system-card"><h2>Daily Operations</h2><p>Run the "End of Day" process to automatically check out guests whose departure date is today or in the past. This frees up rooms for new bookings but keeps all sales records intact.</p><button id="end-of-day-btn" class="primary-btn">Run End of Day Process</button></div> <div class="system-card"><h2>Data Backup & Restore</h2><p>Your data is automatically saved to this browser. You can force a backup or perform a factory reset, which will delete all data and restore the application to its initial state.</p><p class="last-backup-info">Last backup: <span id="last-backup-display">N/A</span></p><div class="action-btn-group" style="margin-top: 15px;"><button id="force-backup-btn" class="primary-btn secondary-btn">Force Backup</button><button id="factory-reset-btn" class="primary-btn danger-btn">Factory Reset</button></div></div> </div>`;

                // --- All Modals ---
                document.getElementById('booking-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2 id="booking-modal-title">Book Room</h2><span class="close-btn" data-modal-id="booking-modal">&times;</span></div><form id="booking-form"><input type="hidden" id="booking-room-id"><div class="form-group"><label for="customer-name">Customer Full Name</label><input type="text" id="customer-name" required></div><div class="form-group"><label for="check-in-date">Check-in Date</label><input type="date" id="check-in-date" required></div><div class="form-group"><label for="check-out-date">Check-out Date</label><input type="date" id="check-out-date" required></div><div class="form-group"><p>Total Price: <strong id="booking-total-price">₦0.00</strong></p></div><div class="modal-footer"><button type="submit" class="primary-btn">Confirm Booking</button></div></form></div>`;
                document.getElementById('new-sale-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2>Log New Sale</h2><span class="close-btn" data-modal-id="new-sale-modal">&times;</span></div><form id="new-sale-form"><div class="form-group"><label for="sale-customer-name">Customer Name (Optional)</label><input type="text" id="sale-customer-name" placeholder="e.g., John Doe or Walk-in"></div><div class="sale-item-adder"><select id="sale-item-select" required><option value="">-- Select Item --</option></select><input type="number" id="sale-item-quantity" placeholder="Qty" min="1" value="1"><button type="button" id="add-item-to-sale-btn" class="secondary-btn primary-btn">Add</button></div><div id="sale-items-list-container"><table class="data-table"><thead><tr><th>Item</th><th>Qty</th><th>Subtotal</th><th></th></tr></thead><tbody id="sale-items-list"></tbody></table></div><h3>Total: <strong id="sale-total-amount">₦0.00</strong></h3><div class="modal-footer"><button type="submit" class="primary-btn">Log Sale & Print Receipt</button></div></form></div>`;
                document.getElementById('receipt-modal').innerHTML = `<div class="modal-content"><div class="modal-header"><h2>Print Receipt</h2><span class="close-btn" data-modal-id="receipt-modal">&times;</span></div><div id="receipt-content-wrapper"><div id="receipt-content"></div></div><div class="modal-footer"><button id="print-receipt-btn" class="primary-btn">Print</button></div></div>`;
                document.getElementById('inventory-modal').innerHTML = `<div class="modal-content" style="max-width: 550px;"><div class="modal-header"><h2 id="inventory-modal-title">Add Item</h2><span class="close-btn" data-modal-id="inventory-modal">&times;</span></div><form id="inventory-form"><input type="hidden" id="inventory-item-id"><div class="form-group"><label for="inventory-item-name">Item Name</label><input type="text" id="inventory-item-name" required></div><div class="form-group"><label for="inventory-department">Department</label><select id="inventory-department" required><option value="Bar">Bar</option><option value="Kitchen">Kitchen</option><option value="Housekeeping">Housekeeping</option><option value="Spa">Spa</option><option value="Maintenance">Maintenance</option></select></div><div class="form-group"><label for="inventory-stock">Current Stock</label><input type="number" id="inventory-stock" required></div><div class="form-group"><label for="inventory-item-cost">Cost Price (₦)</label><input type="number" id="inventory-item-cost" required></div><div class="form-group"><label for="inventory-item-price">Selling Price (₦)</label><input type="number" id="inventory-item-price" required></div><div class="form-group"><label for="inventory-low-stock">Low Stock Threshold</label><input type="number" id="inventory-low-stock" required></div><div class="modal-footer"><button type="submit" class="primary-btn">Save Item</button></div></form></div>`;
                document.getElementById('staff-modal').innerHTML = `<div class="modal-content" style="max-width: 550px;"><div class="modal-header"><h2 id="staff-modal-title">Add Staff</h2><span class="close-btn" data-modal-id="staff-modal">&times;</span></div><form id="staff-form"><input type="hidden" id="staff-id"><div class="form-group"><label for="staff-name">Full Name</label><input type="text" id="staff-name" required></div><div class="form-group"><label for="staff-username">Username (for login access)</label><input type="text" id="staff-username" placeholder="Leave blank if no login needed"></div><div class="form-group"><label for="staff-password">Password</label><input type="password" id="staff-password" placeholder="Required if username is set"></div><div class="form-group"><label for="staff-role">Role</label><select id="staff-role" required><option value="Admin">Admin</option><option value="Manager">Manager</option><option value="Front Desk">Front Desk</option><option value="Cashier">Cashier</option><option value="Waiter">Waiter</option><option value="Housekeeping">Housekeeping</option><option value="Accountant">Accountant</option><option value="Security">Security</option><option value="Maintenance">Maintenance</option></select></div><div class="form-group"><label for="staff-department">Department</label><select id="staff-department" required><option value="Administration">Administration</option><option value="Front Desk">Front Desk</option><option value="Bar">Bar</option><option value="Kitchen">Kitchen</option><option value="Housekeeping">Housekeeping</option><option value="Accounts">Accounts</option><option value="Security">Security</option><option value="Maintenance">Maintenance</option></select></div><div class="form-group"><label for="staff-salary">Salary (Monthly, ₦)</label><input type="number" id="staff-salary" required></div><div class="modal-footer"><button type="submit" class="primary-btn">Save Staff</button></div></form></div>`;
                document.getElementById('asset-modal').innerHTML = `<div class="modal-content" style="max-width: 550px;"><div class="modal-header"><h2 id="asset-modal-title">Add Asset</h2><span class="close-btn" data-modal-id="asset-modal">&times;</span></div><form id="asset-form"><input type="hidden" id="asset-id"><div class="form-group"><label for="asset-name">Asset Name</label><input type="text" id="asset-name" required></div><div class="form-group"><label for="asset-department">Department</label><select id="asset-department" required><option value="Rooms">Rooms</option><option value="Kitchen">Kitchen</option><option value="Bar">Bar</option><option value="Laundry">Laundry</option><option value="Office">Office</option></select></div><div class="form-group"><label for="asset-purchase-date">Purchase Date</label><input type="date" id="asset-purchase-date" required></div><div class="form-group"><label for="asset-value">Purchase Value (₦)</label><input type="number" id="asset-value" required></div><div class="modal-footer"><button type="submit" class="primary-btn">Save Asset</button></div></form></div>`;
                document.getElementById('change-password-modal').innerHTML = `<div class="modal-content" style="max-width: 450px;"><div class="modal-header"><h2>Change Password</h2><span class="close-btn" data-modal-id="change-password-modal">&times;</span></div><form id="change-password-form"><div class="form-group"><label for="current-password">Current Password</label><input type="password" id="current-password" required></div><div class="form-group"><label for="new-password">New Password</label><input type="password" id="new-password" required></div><div class="form-group"><label for="confirm-new-password">Confirm New Password</label><input type="password" id="confirm-new-password" required></div><div class="modal-footer"><button type="submit" class="primary-btn">Update Password</button></div></form></div>`;
                document.getElementById('room-modal').innerHTML = `<div class="modal-content" style="max-width: 450px;"><div class="modal-header"><h2 id="room-modal-title">Add New Room</h2><span class="close-btn" data-modal-id="room-modal">&times;</span></div><form id="room-form"><input type="hidden" id="room-id"><div class="form-group"><label for="room-name-input">Room Name</label><input type="text" id="room-name-input" placeholder="e.g., Room 101" required></div><div class="form-group"><label for="room-type-select">Room Type</label><select id="room-type-select" required><option value="Standard">Standard</option><option value="Deluxe">Deluxe</option><option value="Suite">Suite</option></select></div><div class="form-group"><label for="room-price-input">Price per Night (₦)</label><input type="number" id="room-price-input" min="0" value="0" required></div><div class="modal-footer"><button type="submit" class="primary-btn">Save Room</button></div></form></div>`;
            }

            function generateRooms() {
                if (state.rooms && state.rooms.length > 0) return;
                for (let i = 1; i <= 50; i++) {
                    let type = 'Standard', price = 25000;
                    if (i > 35) { type = 'Deluxe'; price = 40000; }
                    if (i > 45) { type = 'Suite'; price = 75000; }
                    state.rooms.push({ id: i, name: `Room ${i}`, type: type, price: price, status: 'available', guestName: null, checkIn: null, checkOut: null });
                }
            }
            
            function setupEventListeners() {
                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.dataset.modalId)));
                window.addEventListener('click', (e) => { if (e.target.classList.contains('modal')) { closeModal(e.target.id); } });
                
                document.getElementById('booking-form').addEventListener('submit', handleBookingSubmit);
                document.getElementById('new-sale-form').addEventListener('submit', handleNewSaleSubmit);
                document.getElementById('inventory-form').addEventListener('submit', handleInventoryFormSubmit);
                document.getElementById('staff-form').addEventListener('submit', handleStaffFormSubmit);
                document.getElementById('asset-form').addEventListener('submit', handleAssetFormSubmit);
                document.getElementById('change-password-form').addEventListener('submit', handleChangePasswordSubmit);
                document.getElementById('room-form').addEventListener('submit', handleRoomFormSubmit);

                document.getElementById('check-in-date').addEventListener('change', calculateBookingPrice);
                document.getElementById('check-out-date').addEventListener('change', calculateBookingPrice);
                document.getElementById('new-sale-btn').addEventListener('click', openNewSaleModal);
                document.getElementById('add-item-to-sale-btn').addEventListener('click', handleAddItemToSale);
                document.getElementById('print-receipt-btn').addEventListener('click', () => window.print());
                document.getElementById('add-inventory-btn').addEventListener('click', () => openInventoryModal('add'));
                document.getElementById('add-staff-btn').addEventListener('click', () => openStaffModal('add'));
                document.getElementById('add-asset-btn').addEventListener('click', () => openAssetModal('add'));
                document.getElementById('add-room-btn').addEventListener('click', () => openRoomModal('add'));
                document.getElementById('report-filter-btn').addEventListener('click', () => {
                    const start = document.getElementById('report-start-date').value;
                    const end = document.getElementById('report-end-date').value;
                    renderReportsView(start, end);
                });
                document.getElementById('export-csv-btn').addEventListener('click', exportSalesToCSV);
                document.getElementById('change-password-btn').addEventListener('click', openChangePasswordModal);
                document.getElementById('pl-period-select').addEventListener('change', (e) => renderProfitLossView(e.target.value));

                document.getElementById('end-of-day-btn').addEventListener('click', handleEndOfDay);
                document.getElementById('force-backup-btn').addEventListener('click', saveStateToLocalStorage);
                document.getElementById('factory-reset-btn').addEventListener('click', handleFactoryReset);
            }
            
            // =================================================================
            // PERIODIC CHECKS & ALERTS
            // =================================================================
            function startPeriodicChecks() {
                if (checkoutAlertInterval) clearInterval(checkoutAlertInterval);
                runNotificationChecks(); // Run once immediately on login
                checkoutAlertInterval = setInterval(runNotificationChecks, 60 * 1000); // Check every minute
            }

            function runNotificationChecks() {
                if (!state.currentUser) return;

                if (['Front Desk', 'Manager', 'Admin'].includes(state.currentUser.role)) {
                    const today = new Date();
                    today.setHours(23, 59, 59, 999); 
                    const expiredOrDueRooms = state.rooms.filter(room => room.status === 'booked' && new Date(room.checkOut) < today && !transientState.expiredBookingAlertsShown.has(room.id));
                    if (expiredOrDueRooms.length > 0) {
                        const roomNames = expiredOrDueRooms.map(r => `${r.name} (${r.guestName})`).join(', ');
                        alert(`NOTIFICATION: The following bookings are due for checkout or have expired:\n\n${roomNames}\n\nPlease process their checkout or run the End of Day process.`);
                        expiredOrDueRooms.forEach(room => transientState.expiredBookingAlertsShown.add(room.id));
                    }
                }

                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowString = tomorrow.toISOString().split('T')[0];
                const upcomingRooms = state.rooms.filter(room => room.status === 'booked' && room.checkOut === tomorrowString && !transientState.upcomingCheckoutAlertsShown.has(room.id));
                if (upcomingRooms.length > 0) {
                    const roomNames = upcomingRooms.map(r => `${r.name} (${r.guestName})`).join(', ');
                    alert(`REMINDER: The following guests are due for checkout tomorrow:\n\n${roomNames}`);
                    upcomingRooms.forEach(room => transientState.upcomingCheckoutAlertsShown.add(room.id));
                }
            }

            // =================================================================
            // BACKUP, RESTORE & SYSTEM FUNCTIONS
            // =================================================================
            function handleEndOfDay() { if (!confirm("Are you sure you want to run the End of Day process? This will check out all due rooms.")) return; const today = new Date(); today.setHours(0, 0, 0, 0); let checkedOutCount = 0; state.rooms.forEach(room => { if (room.status === 'booked' && room.checkOut) { const checkOutDate = new Date(room.checkOut); if (checkOutDate <= today) { room.status = 'available'; room.guestName = null; room.checkIn = null; room.checkOut = null; checkedOutCount++; } } }); alert(`End of Day process complete. ${checkedOutCount} room(s) have been checked out and are now available.`); saveStateAndReRender(); }
            function handleFactoryReset() { const confirmation = prompt('EXTREME WARNING! This will delete all sales, inventory, and staff data permanently. This action cannot be undone. To confirm, type "RESET" in the box below.'); if (confirmation === 'RESET') { localStorage.removeItem('HotelManagerData'); alert("System has been reset to factory defaults. The application will now reload."); location.reload(); } else { alert("Factory reset cancelled."); } }
            function renderSystemView() { const backupDisplay = document.getElementById('last-backup-display'); if (state.lastBackup) { backupDisplay.textContent = new Date(state.lastBackup).toLocaleString(); } else { backupDisplay.textContent = "Never"; } }
            
            // =================================================================
            // AUTHENTICATION & APP RENDER
            // =================================================================
            function handleLogin(e) { e.preventDefault(); const user = state.staff.find(s => s.username && s.username === document.getElementById('username').value && s.password === document.getElementById('password').value); if (user) { state.currentUser = user; document.getElementById('login-screen').classList.add('hidden'); document.getElementById('main-app').classList.remove('hidden'); document.getElementById('login-error').classList.add('hidden'); renderAppForUser(); } else { document.getElementById('login-error').classList.remove('hidden'); } }
            function handleLogout() { state.currentUser = null; if (checkoutAlertInterval) clearInterval(checkoutAlertInterval); transientState.upcomingCheckoutAlertsShown.clear(); transientState.expiredBookingAlertsShown.clear(); document.getElementById('login-screen').classList.remove('hidden'); document.getElementById('main-app').classList.add('hidden'); document.getElementById('login-form').reset(); }
            function renderAppForUser() { if (!state.currentUser) return; document.getElementById('user-name-display').textContent = state.currentUser.name; document.getElementById('user-role-display').textContent = state.currentUser.role; renderSidebar(); renderAllViews(); const defaultView = state.currentUser.role === 'Admin' ? 'admin-dashboard-view' : 'front-desk-dashboard-view'; switchView(defaultView); startPeriodicChecks(); }
            function renderSidebar() { const nav = document.getElementById('sidebar-nav'); nav.innerHTML = ''; const navLinks = [ { name: 'Dashboard', view: state.currentUser.role === 'Admin' ? 'admin-dashboard-view' : 'front-desk-dashboard-view', roles: ['Admin', 'Front Desk', 'Manager'] }, { name: 'Rooms', view: 'rooms-view', roles: ['Admin', 'Front Desk', 'Manager'] }, { name: 'Sales & Receipts', view: 'sales-view', roles: ['Admin', 'Front Desk', 'Manager'] }, { name: 'Inventory', view: 'inventory-view', roles: ['Admin', 'Manager'] }, { name: 'Staff', view: 'staff-view', roles: ['Admin'] }, { name: 'Assets', view: 'assets-view', roles: ['Admin'] }, { name: 'Reports', view: 'reports-view', roles: ['Admin', 'Manager'] }, { name: 'Profit & Loss', view: 'pl-view', roles: ['Admin'] }, { name: 'System', view: 'system-view', roles: ['Admin'] }, ]; navLinks.forEach(link => { if (link.roles.includes(state.currentUser.role)) { const li = document.createElement('li'); const a = document.createElement('a'); a.href = '#'; a.textContent = link.name; a.dataset.view = link.view; a.addEventListener('click', (e) => { e.preventDefault(); switchView(e.target.dataset.view); }); li.appendChild(a); nav.appendChild(li); } }); }
            function switchView(viewId) { document.querySelectorAll('.content-view').forEach(view => view.classList.add('hidden')); const viewToShow = document.getElementById(viewId); if (viewToShow) { viewToShow.classList.remove('hidden'); if (viewId === 'pl-view') renderProfitLossView(document.getElementById('pl-period-select').value); if (viewId === 'system-view') renderSystemView(); if (viewId === 'reports-view') renderReportsView(); } document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.toggle('active', a.dataset.view === viewId)); }
            function renderAllViews() { renderDashboards(); renderRoomGrid(); renderSalesTable(); if (state.currentUser.role === 'Admin' || state.currentUser.role === 'Manager') { renderInventoryTable(); renderStaffTable(); renderAssetTable(); renderReportsView(); renderSystemView(); } }

            // =================================================================
            // VIEW RENDERING FUNCTIONS
            // =================================================================
            function renderDashboards() { const roomsAvailable = state.rooms.filter(r => r.status === 'available').length; const roomsBooked = state.rooms.length - roomsAvailable; document.getElementById('admin-rooms-available').textContent = roomsAvailable; document.getElementById('admin-rooms-booked').textContent = roomsBooked; const todaySales = state.sales.filter(s => new Date(s.date).toDateString() === new Date().toDateString()).reduce((sum, s) => sum + s.total, 0); document.getElementById('admin-today-sales').textContent = `₦${todaySales.toLocaleString()}`; const lowStockCount = state.inventory.filter(i => i.stock <= i.lowStockThreshold).length; document.getElementById('admin-low-stock-count').textContent = lowStockCount; document.getElementById('fd-rooms-available').textContent = roomsAvailable; document.getElementById('fd-rooms-booked').textContent = roomsBooked; const today = new Date().toISOString().split('T')[0]; const expiringTodayCount = state.rooms.filter(r => r.checkOut === today).length; document.getElementById('fd-expiring-today').textContent = expiringTodayCount; }
            function renderRoomGrid() { const standardGrid = document.getElementById('standard-room-grid'); const deluxeGrid = document.getElementById('deluxe-room-grid'); const suiteGrid = document.getElementById('suite-room-grid'); standardGrid.innerHTML = ''; deluxeGrid.innerHTML = ''; suiteGrid.innerHTML = ''; state.rooms.forEach(room => { const card = document.createElement('div'); card.className = `room-card ${room.status}`; card.dataset.roomId = room.id; card.innerHTML = `<div class="room-details"><div class="room-name">${room.name}</div><div class="room-price">₦${room.price.toLocaleString()}/night</div></div><div class="room-actions ${state.currentUser.role === 'Admin' ? '' : 'hidden'}"><button class="action-btn edit-btn">Edit</button><button class="action-btn delete-btn">Del</button></div>`; card.querySelector('.room-details').addEventListener('click', () => handleRoomClick(room.id)); if (state.currentUser.role === 'Admin') { card.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); openRoomModal('edit', room.id); }); card.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); handleDeleteRoom(room.id); }); } const targetGrid = room.type === 'Standard' ? standardGrid : (room.type === 'Deluxe' ? deluxeGrid : suiteGrid); targetGrid.appendChild(card); }); document.getElementById('add-room-btn').classList.toggle('hidden', state.currentUser.role !== 'Admin'); }
            function renderSalesTable() { const tbody = document.getElementById('sales-table-body'); tbody.innerHTML = ''; state.sales.slice().reverse().forEach(sale => { const row = document.createElement('tr'); row.innerHTML = `<td>#${String(sale.id).slice(-6)}</td><td>${sale.customerName}</td><td>${sale.total.toLocaleString()}</td><td>${sale.staffName}</td><td>${new Date(sale.date).toLocaleString()}</td> <td><button class="action-btn print-btn" data-sale-id="${sale.id}">Reprint</button></td>`; row.querySelector('.print-btn').addEventListener('click', (e) => generateAndShowReceipt(e.target.dataset.saleId)); tbody.appendChild(row); }); }
            function renderInventoryTable() { if (!document.getElementById('inventory-table-body')) return; const tbody = document.getElementById('inventory-table-body'); tbody.innerHTML = ''; state.inventory.forEach(item => { const isLow = item.stock <= item.lowStockThreshold; const row = document.createElement('tr'); row.className = isLow ? 'low-stock' : ''; row.innerHTML = `<td>${item.name}</td><td>${item.department}</td><td>${item.stock}</td><td>${item.cost.toLocaleString()}</td><td>${item.price.toLocaleString()}</td><td>${isLow ? 'Low Stock' : 'OK'}</td> <td><div class="action-btn-group"> <button class="action-btn edit-btn" data-id="${item.id}">Edit</button> <button class="action-btn delete-btn" data-id="${item.id}">Delete</button> </div></td>`; row.querySelector('.edit-btn').addEventListener('click', e => openInventoryModal('edit', e.target.dataset.id)); row.querySelector('.delete-btn').addEventListener('click', e => deleteItem('inventory', e.target.dataset.id)); tbody.appendChild(row); }); }
            function renderStaffTable() { if (!document.getElementById('staff-table-body')) return; const tbody = document.getElementById('staff-table-body'); tbody.innerHTML = ''; state.staff.forEach(user => { const row = document.createElement('tr'); row.innerHTML = `<td>${user.name}</td><td>${user.role}</td><td>${user.department}</td><td>${user.salary.toLocaleString()}</td> <td><div class="action-btn-group"> <button class="action-btn edit-btn" data-id="${user.id}">Edit</button> <button class="action-btn delete-btn" data-id="${user.id}">Delete</button> </div></td>`; row.querySelector('.edit-btn').addEventListener('click', e => openStaffModal('edit', e.target.dataset.id)); row.querySelector('.delete-btn').addEventListener('click', e => deleteItem('staff', e.target.dataset.id)); tbody.appendChild(row); }); }
            function renderAssetTable() { if (!document.getElementById('asset-table-body')) return; const tbody = document.getElementById('asset-table-body'); tbody.innerHTML = ''; state.assets.forEach(asset => { const row = document.createElement('tr'); row.innerHTML = `<td>${asset.name}</td><td>${asset.department}</td><td>${new Date(asset.purchaseDate).toLocaleDateString()}</td><td>${asset.value.toLocaleString()}</td> <td><div class="action-btn-group"> <button class="action-btn edit-btn" data-id="${asset.id}">Edit</button> <button class="action-btn delete-btn" data-id="${asset.id}">Delete</button> </div></td>`; row.querySelector('.edit-btn').addEventListener('click', e => openAssetModal('edit', e.target.dataset.id)); row.querySelector('.delete-btn').addEventListener('click', e => deleteItem('asset', e.target.dataset.id)); tbody.appendChild(row); }); }
            function renderReportsView(start, end) { if (!document.getElementById('reports-summary-grid')) return; const container = document.getElementById('reports-summary-grid'); const trendsBody = document.getElementById('consumption-trends-body'); container.innerHTML = ''; trendsBody.innerHTML = ''; let filteredSales = state.sales; if (start && end) { const startDate = new Date(start); const endDate = new Date(end); endDate.setHours(23, 59, 59, 999); filteredSales = state.sales.filter(s => { const saleDate = new Date(s.date); return saleDate >= startDate && saleDate <= endDate; }); } const salesByDept = filteredSales.reduce((acc, sale) => { const dept = sale.type; if (!acc[dept]) acc[dept] = 0; acc[dept] += sale.total; return acc; }, {}); for(const dept in salesByDept) { container.innerHTML += `<div class="widget"><h3>${dept} Sales</h3><p class="value">₦${salesByDept[dept].toLocaleString()}</p></div>`; } if(Object.keys(salesByDept).length === 0) container.innerHTML = `<div class="widget"><h3>No Sales Data</h3><p class="value">₦0</p></div>`; const consumption = {}; filteredSales.forEach(sale => { sale.items.forEach(item => { if (item.inventoryId) { if (!consumption[item.inventoryId]) { consumption[item.inventoryId] = { name: item.name, department: item.department || 'N/A', count: 0 }; } consumption[item.inventoryId].count += item.quantity; } }); }); const sortedConsumption = Object.values(consumption).sort((a,b) => b.count - a.count); sortedConsumption.forEach(item => { trendsBody.innerHTML += `<tr><td>${item.name}</td><td>${item.department}</td><td>${item.count}</td></tr>`; }); }
            function calculateProfitAndLoss(startDate, endDate) { const salesInPeriod = state.sales.filter(s => { const saleDate = new Date(s.date); return saleDate >= startDate && saleDate <= endDate; }); const revenue = salesInPeriod.reduce((sum, s) => sum + s.total, 0); let cogs = 0; salesInPeriod.forEach(sale => { if (sale.type !== 'Booking') { sale.items.forEach(item => { cogs += item.costPerItem * item.quantity; }); } }); const totalMonthlySalary = state.staff.reduce((sum, u) => sum + u.salary, 0); let salaryExpense = 0; const timeDiff = endDate.getTime() - startDate.getTime(); const daysInPeriod = timeDiff / (1000 * 3600 * 24) + 1; if (daysInPeriod <= 1) { salaryExpense = totalMonthlySalary / 30; } else if (daysInPeriod <= 31) { salaryExpense = totalMonthlySalary; } else { salaryExpense = totalMonthlySalary * 12; } const assetExpense = state.assets.filter(a => { const purchaseDate = new Date(a.purchaseDate); return purchaseDate >= startDate && purchaseDate <= endDate; }).reduce((sum, a) => sum + a.value, 0); const totalExpenses = cogs + salaryExpense + assetExpense; const profit = revenue - totalExpenses; return { revenue, cogs, salaryExpense, assetExpense, profit }; }
            function renderProfitLossView(period) { const now = new Date(); let startDate, endDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59); switch(period) { case 'daily': startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0); break; case 'yearly': startDate = new Date(now.getFullYear(), 0, 1, 0, 0, 0); endDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59); break; case 'monthly': default: startDate = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0); endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59); break; } const data = calculateProfitAndLoss(startDate, endDate); const grid = document.getElementById('pl-summary-grid'); grid.innerHTML = ` <div class="widget"><h3 style="color: var(--green);">Total Revenue</h3><p class="value green">₦${data.revenue.toLocaleString()}</p></div> <div class="widget"><h3 style="color: var(--red);">Cost of Goods Sold</h3><p class="value red">₦${data.cogs.toLocaleString()}</p></div> <div class="widget"><h3 style="color: var(--red);">Salary Expenses</h3><p class="value red">₦${Math.round(data.salaryExpense).toLocaleString()}</p></div> <div class="widget"><h3 style="color: var(--red);">Asset Purchases</h3><p class="value red">₦${data.assetExpense.toLocaleString()}</p></div> <div class="widget"> <h3>Net Profit / Loss</h3> <p class="value ${data.profit >= 0 ? 'green' : 'red'}">₦${data.profit.toLocaleString()}</p> </div> `; }

            // =================================================================
            // ACTION HANDLERS & LOGIC
            // =================================================================
            function handleRoomClick(roomId) { const room = state.rooms.find(r => r.id == roomId); if (room.status === 'available') { openBookingModal(roomId); } else { if (confirm(`Room ${room.name} is booked by ${room.guestName}.\nCheck-out Date: ${new Date(room.checkOut).toLocaleDateString()}.\n\nDo you want to check out this guest now?`)) { handleEarlyCheckout(roomId); } } }
            function handleEarlyCheckout(roomId) { const room = state.rooms.find(r => r.id == roomId); if (!room) return; room.status = 'available'; room.guestName = null; room.checkIn = null; room.checkOut = null; alert(`Room ${room.name} has been checked out and is now available.`); saveStateAndReRender(); }
            function openBookingModal(roomId) { const room = state.rooms.find(r => r.id == roomId); document.getElementById('booking-form').reset(); document.getElementById('booking-room-id').value = roomId; document.getElementById('booking-modal-title').textContent = `Book ${room.name} (${room.type})`; document.getElementById('booking-total-price').textContent = '₦0.00'; const today = new Date().toISOString().split('T')[0]; document.getElementById('check-in-date').min = today; document.getElementById('check-out-date').min = today; openModal('booking-modal'); }
            function calculateBookingPrice() { const roomId = document.getElementById('booking-room-id').value; const room = state.rooms.find(r => r.id == roomId); const checkInDate = new Date(document.getElementById('check-in-date').value); const checkOutDate = new Date(document.getElementById('check-out-date').value); if (room && checkInDate && checkOutDate && checkOutDate > checkInDate) { const days = Math.ceil((checkOutDate - checkInDate) / (1000 * 3600 * 24)); const totalPrice = days * room.price; document.getElementById('booking-total-price').textContent = `₦${totalPrice.toLocaleString()}`; } else { document.getElementById('booking-total-price').textContent = '₦0.00'; } }
            function handleBookingSubmit(e) { e.preventDefault(); const roomId = document.getElementById('booking-room-id').value; const room = state.rooms.find(r => r.id == roomId); const customerName = document.getElementById('customer-name').value; const checkIn = document.getElementById('check-in-date').value; const checkOut = document.getElementById('check-out-date').value; if (!customerName || !checkIn || !checkOut || new Date(checkOut) <= new Date(checkIn)) { alert('Please fill all fields correctly. Check-out date must be after check-in date.'); return; } deductWelcomeKitFromInventory(room.type); room.status = 'booked'; room.guestName = customerName; room.checkIn = checkIn; room.checkOut = checkOut; const days = Math.ceil((new Date(checkOut) - new Date(checkIn)) / (1000 * 3600 * 24)); const total = days * room.price; const sale = { id: Date.now(), type: 'Booking', customerName: customerName, staffName: state.currentUser.name, date: new Date().toISOString(), items: [{ inventoryId: null, name: `${room.name} x ${days} night(s)`, quantity: 1, pricePerItem: total, costPerItem: 0 }], total: total }; state.sales.push(sale); closeModal('booking-modal'); generateAndShowReceipt(sale.id); saveStateAndReRender(); }
            function deductWelcomeKitFromInventory(roomType) { const itemsToDeduct = [ { name: 'Guest Water Bottle', qty: { 'Standard': 1, 'Deluxe': 2, 'Suite': 2 } }, { name: 'Guest Shampoo', qty: { 'Standard': 1, 'Deluxe': 1, 'Suite': 2 } }, { name: 'Guest Soap', qty: { 'Standard': 1, 'Deluxe': 2, 'Suite': 2 } } ]; let stockWarning = ''; itemsToDeduct.forEach(kitItem => { const inventoryItem = state.inventory.find(i => i.name === kitItem.name); const qtyToDeduct = kitItem.qty[roomType] || 1; if (inventoryItem) { if(inventoryItem.stock >= qtyToDeduct) { inventoryItem.stock -= qtyToDeduct; } else { stockWarning += `\n- Not enough ${inventoryItem.name}. Required: ${qtyToDeduct}, Available: ${inventoryItem.stock}.`; inventoryItem.stock = 0; } } }); if(stockWarning) { alert('Warning: Some welcome kit items are out of stock. Booking will proceed.' + stockWarning); } }
            function openNewSaleModal() { currentSaleItems = []; document.getElementById('new-sale-form').reset(); const select = document.getElementById('sale-item-select'); select.innerHTML = '<option value="">-- Select Item --</option>'; state.inventory.filter(i => i.stock > 0).forEach(item => { select.innerHTML += `<option value="${item.id}">${item.name} (Stock: ${item.stock})</option>`; }); renderSaleCart(); openModal('new-sale-modal'); }
            function handleAddItemToSale() { const itemId = document.getElementById('sale-item-select').value; const quantity = parseInt(document.getElementById('sale-item-quantity').value); if (!itemId || isNaN(quantity) || quantity <= 0) { alert('Please select an item and enter a valid quantity.'); return; } const inventoryItem = state.inventory.find(i => i.id == itemId); const existingCartItem = currentSaleItems.find(i => i.inventoryId == itemId); const currentStock = inventoryItem.stock; const quantityInCart = existingCartItem ? existingCartItem.quantity : 0; if (quantity > (currentStock - quantityInCart)) { alert(`Not enough stock for ${inventoryItem.name}. Available: ${currentStock}, In Cart: ${quantityInCart}. You can add at most ${currentStock - quantityInCart}.`); return; } if(existingCartItem) { existingCartItem.quantity += quantity; } else { currentSaleItems.push({ inventoryId: inventoryItem.id, name: inventoryItem.name, quantity: quantity, pricePerItem: inventoryItem.price, costPerItem: inventoryItem.cost, department: inventoryItem.department }); } renderSaleCart(); }
            function renderSaleCart() { const cartBody = document.getElementById('sale-items-list'); cartBody.innerHTML = ''; let total = 0; currentSaleItems.forEach((item, index) => { const subtotal = item.quantity * item.pricePerItem; total += subtotal; const row = document.createElement('tr'); row.innerHTML = `<td>${item.name}</td><td>${item.quantity}</td><td>${subtotal.toLocaleString()}</td><td><button type="button" class="action-btn delete-btn" data-index="${index}">X</button></td>`; row.querySelector('.delete-btn').addEventListener('click', (e) => { currentSaleItems.splice(e.target.dataset.index, 1); renderSaleCart(); }); cartBody.appendChild(row); }); document.getElementById('sale-total-amount').textContent = `₦${total.toLocaleString()}`; }
            function handleNewSaleSubmit(e) { e.preventDefault(); if (currentSaleItems.length === 0) { alert('Please add at least one item to the sale.'); return; } currentSaleItems.forEach(cartItem => { const inventoryItem = state.inventory.find(i => i.id === cartItem.inventoryId); inventoryItem.stock -= cartItem.quantity; }); const total = currentSaleItems.reduce((sum, item) => sum + (item.quantity * item.pricePerItem), 0); const mainDepartment = currentSaleItems.length > 0 ? currentSaleItems[0].department : 'General'; const sale = { id: Date.now(), type: mainDepartment, customerName: document.getElementById('sale-customer-name').value || 'Walk-in', staffName: state.currentUser.name, date: new Date().toISOString(), items: [...currentSaleItems], total: total, }; state.sales.push(sale); closeModal('new-sale-modal'); generateAndShowReceipt(sale.id); saveStateAndReRender(); }
            function generateAndShowReceipt(saleId) { const sale = state.sales.find(s => s.id == saleId); if (!sale) return; const receiptContent = document.getElementById('receipt-content'); let itemsHtml = ''; sale.items.forEach(item => { const subtotal = item.quantity * item.pricePerItem; itemsHtml += `<tr><td>${item.name} (x${item.quantity})</td><td style="text-align: right;">₦${subtotal.toLocaleString()}</td></tr>`; }); receiptContent.innerHTML = `<div id="receipt-header" style="text-align:center; margin-bottom: 20px;"><h3>HOTEL MANAGER</h3><p>Official Receipt</p></div><div id="receipt-details" style="margin-bottom: 20px;"><p><strong>Receipt ID:</strong> #${String(sale.id).slice(-6)}</p><p><strong>Date:</strong> ${new Date(sale.date).toLocaleString()}</p><p><strong>Customer:</strong> ${sale.customerName}</p><p><strong>Served by:</strong> ${sale.staffName}</p></div><div id="receipt-items"><table style="width:100%; border-collapse: collapse;"><thead><tr><th style="text-align:left;">Description</th><th style="text-align: right;">Amount</th></tr><tr><td colspan="2" style="border-bottom: 1px dashed #333; padding-top: 5px;"></td></tr></thead><tbody style="padding-top:10px;">${itemsHtml}</tbody></table></div><div id="receipt-total" style="text-align:right; margin-top:20px; font-weight:bold; font-size: 1.2em;"><p>TOTAL: ₦${sale.total.toLocaleString()}</p></div><div id="receipt-footer" style="text-align:center; margin-top:30px;"><p>Thank you for your patronage!</p></div>`; openModal('receipt-modal'); }
            function openChangePasswordModal() { document.getElementById('change-password-form').reset(); openModal('change-password-modal'); }
            function handleChangePasswordSubmit(e) { e.preventDefault(); const currentPassword = document.getElementById('current-password').value; const newPassword = document.getElementById('new-password').value; const confirmNewPassword = document.getElementById('confirm-new-password').value; if (newPassword !== confirmNewPassword) { alert('New passwords do not match.'); return; } if (state.currentUser.password !== currentPassword) { alert('Current password is incorrect.'); return; } const userInState = state.staff.find(s => s.id === state.currentUser.id); userInState.password = newPassword; state.currentUser.password = newPassword; alert('Password changed successfully!'); closeModal('change-password-modal'); saveStateAndReRender(); }
            function openInventoryModal(mode, id = null) { const form = document.getElementById('inventory-form'); form.reset(); document.getElementById('inventory-modal-title').textContent = mode === 'add' ? 'Add New Item' : 'Edit Item'; if (mode === 'edit') { const item = state.inventory.find(i => i.id == id); document.getElementById('inventory-item-id').value = item.id; document.getElementById('inventory-item-name').value = item.name; document.getElementById('inventory-department').value = item.department; document.getElementById('inventory-stock').value = item.stock; document.getElementById('inventory-item-cost').value = item.cost; document.getElementById('inventory-item-price').value = item.price; document.getElementById('inventory-low-stock').value = item.lowStockThreshold; } else { document.getElementById('inventory-item-id').value = ''; } openModal('inventory-modal'); }
            function handleInventoryFormSubmit(e) { e.preventDefault(); const id = document.getElementById('inventory-item-id').value; const newItemData = { id: id ? parseInt(id) : Date.now(), name: document.getElementById('inventory-item-name').value, department: document.getElementById('inventory-department').value, stock: parseInt(document.getElementById('inventory-stock').value), cost: parseFloat(document.getElementById('inventory-item-cost').value), price: parseFloat(document.getElementById('inventory-item-price').value), lowStockThreshold: parseInt(document.getElementById('inventory-low-stock').value), }; if (id) { const index = state.inventory.findIndex(i => i.id == id); state.inventory[index] = newItemData; } else { state.inventory.push(newItemData); } closeModal('inventory-modal'); saveStateAndReRender(); }
            function openStaffModal(mode, id = null) { const form = document.getElementById('staff-form'); form.reset(); document.getElementById('staff-modal-title').textContent = mode === 'add' ? 'Add New Staff' : 'Edit Staff'; if (mode === 'edit') { const user = state.staff.find(u => u.id == id); document.getElementById('staff-id').value = user.id; document.getElementById('staff-name').value = user.name; document.getElementById('staff-username').value = user.username || ''; document.getElementById('staff-role').value = user.role; document.getElementById('staff-department').value = user.department; document.getElementById('staff-salary').value = user.salary; } else { document.getElementById('staff-id').value = ''; } openModal('staff-modal'); }
            function handleStaffFormSubmit(e) { e.preventDefault(); const id = document.getElementById('staff-id').value; const username = document.getElementById('staff-username').value.trim(); const password = document.getElementById('staff-password').value; if (!id && username && !password) { alert('A password is required for new staff with login access.'); return; } const isDuplicate = state.staff.some(s => s.username && s.username === username && s.id != id); if (username && isDuplicate) { alert('This username is already taken. Please choose another one.'); return; } if (id) { const index = state.staff.findIndex(u => u.id == id); state.staff[index].name = document.getElementById('staff-name').value; state.staff[index].username = username; state.staff[index].role = document.getElementById('staff-role').value; state.staff[index].department = document.getElementById('staff-department').value; state.staff[index].salary = parseInt(document.getElementById('staff-salary').value); if (password) state.staff[index].password = password; } else { const newUser = { id: Date.now(), name: document.getElementById('staff-name').value, username: username, password: password, role: document.getElementById('staff-role').value, department: document.getElementById('staff-department').value, salary: parseInt(document.getElementById('staff-salary').value), }; state.staff.push(newUser); } closeModal('staff-modal'); saveStateAndReRender(); }
            function openAssetModal(mode, id = null) { const form = document.getElementById('asset-form'); form.reset(); document.getElementById('asset-modal-title').textContent = mode === 'add' ? 'Add New Asset' : 'Edit Asset'; if (mode === 'edit') { const asset = state.assets.find(a => a.id == id); document.getElementById('asset-id').value = asset.id; document.getElementById('asset-name').value = asset.name; document.getElementById('asset-department').value = asset.department; document.getElementById('asset-purchase-date').value = asset.purchaseDate; document.getElementById('asset-value').value = asset.value; } else { document.getElementById('asset-id').value = ''; } openModal('asset-modal'); }
            function handleAssetFormSubmit(e) { e.preventDefault(); const id = document.getElementById('asset-id').value; const newAsset = { id: id ? parseInt(id) : Date.now(), name: document.getElementById('asset-name').value, department: document.getElementById('asset-department').value, purchaseDate: document.getElementById('asset-purchase-date').value, value: parseInt(document.getElementById('asset-value').value), }; if (id) { const index = state.assets.findIndex(a => a.id == id); state.assets[index] = newAsset; } else { state.assets.push(newAsset); } closeModal('asset-modal'); saveStateAndReRender(); }
            function openRoomModal(mode, id = null) { const form = document.getElementById('room-form'); form.reset(); document.getElementById('room-modal-title').textContent = mode === 'add' ? 'Add New Room' : 'Edit Room'; if (mode === 'edit') { const room = state.rooms.find(r => r.id == id); document.getElementById('room-id').value = room.id; document.getElementById('room-name-input').value = room.name; document.getElementById('room-type-select').value = room.type; document.getElementById('room-price-input').value = room.price; } else { document.getElementById('room-id').value = ''; } openModal('room-modal'); }
            function handleRoomFormSubmit(e) { e.preventDefault(); const id = document.getElementById('room-id').value; const newRoom = { id: id ? parseInt(id) : Date.now(), name: document.getElementById('room-name-input').value, type: document.getElementById('room-type-select').value, price: parseFloat(document.getElementById('room-price-input').value), status: 'available', guestName: null, checkIn: null, checkOut: null }; if (id) { const index = state.rooms.findIndex(r => r.id == id); const existingRoom = state.rooms[index]; newRoom.status = existingRoom.status; newRoom.guestName = existingRoom.guestName; newRoom.checkIn = existingRoom.checkIn; newRoom.checkOut = existingRoom.checkOut; state.rooms[index] = newRoom; } else { state.rooms.push(newRoom); } closeModal('room-modal'); saveStateAndReRender(); }
            function handleDeleteRoom(roomId) { const room = state.rooms.find(r => r.id == roomId); if (room.status === 'booked') { alert('Cannot delete a room that is currently booked.'); return; } if (confirm(`Are you sure you want to delete ${room.name}? This action cannot be undone.`)) { state.rooms = state.rooms.filter(r => r.id != roomId); saveStateAndReRender(); } }
            function deleteItem(itemType, id) { if (!confirm(`Are you sure you want to delete this ${itemType}? This action cannot be undone.`)) return; if (itemType === 'inventory') { state.inventory = state.inventory.filter(i => i.id != id); } else if (itemType === 'staff') { if (id == state.currentUser.id) { alert("You cannot delete your own account."); return; } state.staff = state.staff.filter(u => u.id != id); } else if (itemType === 'asset') { state.assets = state.assets.filter(a => a.id != id); } saveStateAndReRender(); }
            function exportSalesToCSV() { let csvContent = "data:text/csv;charset=utf-8,Receipt ID,Type,Customer,Staff,Date,Total (NGN)\n"; state.sales.forEach(sale => { const row = [sale.id, sale.type, `"${sale.customerName}"`, `"${sale.staffName}"`, new Date(sale.date).toISOString(), sale.total]; csvContent += row.join(",") + "\n"; }); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", "hotel_manager_sales_report.csv"); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
            function openModal(modalId) { document.getElementById(modalId)?.classList.remove('hidden'); }
            function closeModal(modalId) { document.getElementById(modalId)?.classList.add('hidden'); }

            init();
        });
    </script>
</body>
</html>





